version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        # Write server-only secrets (NO NEXT_PUBLIC_) to .env.production
        - echo "RESEND_API_KEY=$RESEND_API_KEY" >> .env.production
        - echo "FROM_EMAIL=$FROM_EMAIL" >> .env.production
        - echo "CONTACT_RECEIVER=$CONTACT_RECEIVER" >> .env.production
        - echo "AFFILIATE_RECEIVER=$AFFILIATE_RECEIVER" >> .env.production

        # Write any client-visible vars to .env.production too
        - if [ -n "$NEXT_PUBLIC_GA_ID" ]; then echo "NEXT_PUBLIC_GA_ID=$NEXT_PUBLIC_GA_ID" >> .env.production; fi
        - if [ -n "$NEXT_PUBLIC_GTM_ID" ]; then echo "NEXT_PUBLIC_GTM_ID=$NEXT_PUBLIC_GTM_ID" >> .env.production; fi

        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
